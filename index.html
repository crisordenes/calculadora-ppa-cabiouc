<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora PPA â€” CABIOUC</title>
<link rel="icon" type="image/png" href="https://i.ibb.co/JjN0BKLC/Whats-App-Image-2025-12-10-at-21-40-35.jpg">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
:root {
  --uc: #95cdcf;
  --uc-dark: #0033A0;
  --gold: #FFB800;
  --bg: #f0ede8;
  --text: #1a1a2e;
  --muted: #7a7a8a;
  --green: #2e7d52;
  --green-bg: #e8f5ee;
  --red: #c0392b;
  --red-bg: #fdf0ee;
  --orange: #d4650a;
  --orange-bg: #fff4ec;
  --row-bg: #ffffff;
  --final-bg: #ffffff;
  --input-bg: #ffffff;
  --no-grade-bg: #f5f5f5;
  --no-grade-color: #999;
  --border-col: #e8e4dc;
  --el-input-bg: #ffffff;
  --select-bg: #ffffff;
}
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0f1117;
    --text: #e8e4dc;
    --muted: #8a8a9a;
    --green-bg: #0a2218;
    --red-bg: #250d0a;
    --orange-bg: #251500;
    --row-bg: #1a1d27;
    --final-bg: #1a1d27;
    --input-bg: #232635;
    --no-grade-bg: #13161f;
    --no-grade-color: #555;
    --border-col: #2a2d3a;
    --el-input-bg: #232635;
    --select-bg: #232635;
  }
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: Arial, sans-serif; background:var(--bg); color:var(--text); min-height:100vh; transition:background 0.3s,color 0.3s; }

#screen-career {
  min-height:100vh; display:flex; flex-direction:column;
  align-items:center; justify-content:center; padding:40px 20px;
  background:var(--uc); position:relative; overflow:hidden;
}
#screen-career::before { content:''; position:absolute; width:600px; height:600px; border-radius:50%; border:80px solid rgba(255,255,255,0.06); top:-200px; right:-200px; }
#screen-career::after  { content:''; position:absolute; width:400px; height:400px; border-radius:50%; border:50px solid rgba(255,184,0,0.25); bottom:-150px; left:-100px; }
.career-logo { font-family: Arial, sans-serif; color:white; text-align:center; margin-bottom:48px; position:relative; z-index:1; text-shadow: 1px 1px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; }
.main-logo { width: 120px; height: auto; margin-bottom: 16px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); background: white; padding: 4px; }
.career-logo h1 { font-size:2.4rem; font-weight:700; letter-spacing:-1px; }
.career-logo p { color:rgba(255,255,255,0.9); font-size:0.9rem; margin-top:6px; font-weight: bold; }
.gold-line { width:48px; height:4px; background:var(--gold); margin:14px auto; border-radius:2px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.career-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; max-width:860px; width:100%; position:relative; z-index:1; }
.career-card { background:rgba(255,255,255,0.2); border:1.5px solid rgba(255,255,255,0.3); border-radius:16px; padding:28px 24px; cursor:pointer; transition:all 0.25s; display:flex; flex-direction:column; align-items:center; text-align:center; }
.career-card:hover { background:rgba(255,255,255,0.4); border-color:var(--gold); transform:translateY(-4px); }
.career-icon { font-size:2.5rem; margin-bottom:12px; }
.career-card h3 { font-family: Arial, sans-serif; color:white; font-size:1.1rem; margin-bottom:6px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }

#screen-calc { display:none; min-height:100vh; }
.calc-header { background:var(--uc); color:white; padding:20px 32px; display:flex; align-items:center; gap:16px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
.back-btn { background:rgba(255,255,255,0.3); border:none; color:white; width:36px; height:36px; border-radius:50%; cursor:pointer; font-size:1.1rem; display:flex; align-items:center; justify-content:center; transition:background 0.2s; }
.back-btn:hover { background:rgba(255,255,255,0.5); }
.calc-header-info h2 { font-family: Arial, sans-serif; font-size:1.2rem; }
.calc-header-info p { font-size:0.78rem; color:rgba(255,255,255,0.9); font-weight: bold; }

.stats-bar {
  position:sticky; top:0; z-index:100; background:var(--uc);
  border-bottom:4px solid var(--gold); padding:14px 32px;
  display:flex; align-items:center; gap:28px; flex-wrap:wrap;
  box-shadow:0 4px 16px rgba(0,0,0,0.15);
}
.ppa-main .big { font-family: Arial, sans-serif; font-size:2.4rem; font-weight:700; color:white; line-height:1; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
.ppa-main .big.good { color:#1e5e3d; }
.ppa-main .big.warn { color:#d4650a; }
.ppa-main .big.bad  { color:#c0392b; }
.ppa-main .lbl { font-size:0.68rem; color:rgba(255,255,255,0.9); margin-top:3px; text-transform:uppercase; letter-spacing:1px; font-weight:bold; }
.stat-divider { width:1px; height:36px; background:rgba(255,255,255,0.3); }
.stat-item .val { font-family: Arial, sans-serif; font-size:1.6rem; font-weight:700; color:white; line-height:1; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
.stat-item .val.red { color:#c0392b; }
.stat-item .val.prog { color:var(--gold); }
.stat-item .lbl { font-size:0.68rem; color:rgba(255,255,255,0.9); margin-top:3px; text-transform:uppercase; letter-spacing:0.5px; font-weight:bold; }

.calc-content { max-width:920px; margin:0 auto; padding:32px 24px 40px; }
.year-label { font-family: Arial, sans-serif; font-size:1.15rem; color:var(--text); margin:32px 0 10px; font-weight:700; border-left:5px solid var(--gold); padding-left:12px; }
.section { margin-bottom:24px; }
.section-header { display:flex; align-items:center; gap:10px; margin-bottom:12px; padding-bottom:10px; border-bottom:2px solid var(--uc); }
.section-num { background:var(--uc); color:white; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.72rem; font-weight:bold; flex-shrink:0; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
.section-header h3 { font-family: Arial, sans-serif; font-size:1rem; color:var(--text); font-weight:bold; }
.section-credits { margin-left:auto; font-size:0.73rem; color:var(--muted); }
.optional-note { font-size:0.75rem; color:var(--muted); font-style:italic; margin-bottom:8px; padding-left:4px; }
.info-pill { display:inline-block; background:var(--uc-dark); color:#ffffff; font-size:0.75rem; padding:8px 14px; border-radius:8px; margin-bottom:12px; font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.15); letter-spacing: 0.3px; }

.course-row {
  display:grid; grid-template-columns:1fr 100px 90px 30px;
  gap:10px; align-items:center; padding:10px 14px;
  background:var(--row-bg); border-radius:10px; margin-bottom:6px;
  border:1.5px solid transparent; transition:border-color 0.15s, background 0.3s;
}
.course-row:hover { border-color:#d4cfc8; }
.course-row.graded   { background:var(--green-bg);  border-color:#b8dfc9; }
.course-row.failed   { background:var(--red-bg);    border-color:#f0c4be; }
.course-code { font-size:0.66rem; color:var(--muted); font-weight:bold; text-transform:uppercase; }
.course-name { font-size:0.87rem; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.course-crd  { font-size:0.7rem; color:var(--muted); margin-top:1px; }
.grade-input { width:100%; border:1.5px solid #ddd; border-radius:8px; padding:7px 10px; font-family: Arial, sans-serif; font-size:0.9rem; font-weight:bold; text-align:center; background:var(--input-bg); color:var(--text); transition:border-color 0.15s; }
.grade-input:focus { outline:none; border-color:var(--uc); }
.grade-input.valid   { border-color:var(--green); color:var(--green); }
.grade-input.invalid { border-color:var(--red);   color:var(--red);   }
.course-status { font-size:0.72rem; color:var(--muted); text-align:center; }
.course-row.graded   .course-status { color:var(--green);  font-weight:bold; }
.course-row.failed   .course-status { color:var(--red);    font-weight:bold; }

.final-section { background:var(--final-bg); border-radius:16px; padding:28px; border:2px solid var(--border-col); margin-top:8px; }
.final-section h3 { font-family: Arial, sans-serif; font-size:1.05rem; font-weight:bold; color:var(--text); margin-bottom:20px; }
.elective-block { margin-bottom:24px; }
.elective-block h4 { font-size:0.8rem; color:var(--muted); font-weight:bold; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px; }
.elective-row { display:grid; grid-template-columns:1fr 90px 30px; gap:8px; align-items:center; margin-bottom:6px; }
.elective-row.four-col { grid-template-columns:1fr 70px 90px 30px; }
.el-input  { border:1.5px solid var(--border-col); border-radius:8px; padding:7px 10px; font-family: Arial, sans-serif; font-size:0.82rem; width:100%; background:var(--el-input-bg); color:var(--text); }
.el-input:focus { outline:none; border-color:var(--uc); }
.el-select { border:1.5px solid var(--border-col); border-radius:8px; padding:7px 10px; font-family: Arial, sans-serif; font-size:0.82rem; width:100%; background:var(--select-bg); color:var(--text); }
.add-btn { background:none; border:1.5px dashed #bbb; color:#999; padding:7px 16px; border-radius:8px; cursor:pointer; font-family: Arial, sans-serif; font-size:0.82rem; margin-top:6px; transition:all 0.2s; font-weight:bold; }
.add-btn:hover { border-color:var(--uc); color:var(--text); }
.del-btn { background:none; border:none; color:#ccc; font-size:1.3rem; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.del-btn:hover { color:var(--red); }
.exam-box { background:var(--final-bg); border:2px solid var(--gold); border-radius:12px; padding:18px 20px; display:flex; align-items:center; gap:20px; margin-bottom:20px; }
.exam-info h4 { font-family: Arial, sans-serif; font-weight:bold; font-size:1rem; }
.exam-info p  { font-size:0.76rem; color:var(--muted); margin-top:3px; }
.exam-input { width:110px; border:2px solid var(--gold); border-radius:10px; padding:10px; font-family: Arial, sans-serif; font-size:1.3rem; font-weight:bold; text-align:center; color:var(--text); background:var(--el-input-bg); flex-shrink:0; }
.exam-input:focus { outline:none; }
.final-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.final-box { background:var(--uc); border-radius:12px; padding:18px 20px; color:white; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
.final-box .fl { font-size:0.68rem; opacity:0.8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px; font-weight:bold; }
.final-box .fn { font-family: Arial, sans-serif; font-size:2rem; font-weight:bold; }
.final-box .formula { font-size:0.68rem; opacity:0.8; margin-top:6px; }
.reset-row { display:flex; justify-content:center; margin-top:28px; }
.reset-btn-main { background:none; border:1.5px solid #ccc; color:var(--muted); padding:8px 20px; border-radius:20px; cursor:pointer; font-family: Arial, sans-serif; font-size:0.8rem; transition:all 0.2s; font-weight:bold; }
.reset-btn-main:hover { border-color:var(--red); color:var(--red); }
.no-grade-row { display:flex; align-items:center; gap:10px; padding:8px 14px; background:var(--no-grade-bg); border-radius:10px; margin-bottom:6px; font-size:0.82rem; color:var(--no-grade-color); }

#toast-felicidades {
  visibility: hidden; min-width: 250px; background-color: var(--green); color: #fff;
  text-align: center; border-radius: 8px; padding: 16px; position: fixed;
  z-index: 10000; left: 50%; bottom: 30px; transform: translateX(-50%);
  font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  opacity: 0; transition: opacity 0.5s, bottom 0.5s;
}
#toast-felicidades.show { visibility: visible; opacity: 1; bottom: 50px; }

.fifth-year-box { background:var(--uc); color:white; padding:20px; text-align:center; border-radius:12px; margin-top:30px; margin-bottom:10px; font-weight:bold; letter-spacing:1px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }

.btn-link { background:none; border:none; color:var(--text); text-decoration:underline; cursor:pointer; padding:0; font-family: Arial, sans-serif; }
.modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center; }
.modal-box { background:var(--bg); color:var(--text); width:95%; max-width:550px; padding:24px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.5); max-height:90vh; overflow-y:auto; }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; border-bottom:2px solid var(--uc); padding-bottom:10px; }
.modal-header h3 { color:var(--text); font-family: Arial, sans-serif; font-weight:bold; }
.close-btn { background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--muted); }
.exam-settings { background:var(--row-bg); padding:14px; border-radius:8px; margin-bottom:16px; border:1.5px solid var(--border-col); }
.sim-row { display:grid; grid-template-columns: 1fr 70px 70px 30px; gap:8px; margin-bottom:8px; align-items:center; }
.sim-input { width:100%; border:1.5px solid #ddd; border-radius:6px; padding:6px; font-family: Arial, sans-serif; font-size:0.85rem; text-align:center; background:var(--input-bg); color:var(--text); }
.sim-input-text { text-align:left; }
.sim-add-btn { background:rgba(149, 205, 207, 0.2); color:var(--text); border:none; padding:8px; border-radius:6px; cursor:pointer; font-size:0.8rem; width:100%; margin-top:8px; font-weight:bold; }
.sim-results { background:var(--final-bg); border:1.5px solid var(--border-col); border-radius:8px; padding:16px; margin-top:16px; }
.sim-results p { margin-bottom:6px; font-size:0.9rem; display:flex; justify-content:space-between; align-items:center; }
.sim-results strong { color:var(--text); }
.sim-results .req-grade { color:var(--red); font-weight:bold; font-size:1.1rem; }
.sim-save-btn { background:var(--green); color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-size:0.9rem; width:100%; margin-top:16px; font-weight:bold; transition: background 0.2s; }
.sim-save-btn:hover { background: #236140; }
.retry-btn { margin-top:4px; padding:6px; background-color:var(--orange-bg); color:var(--orange); border:none; width:100%; border-radius:6px; font-weight:bold; cursor:pointer; font-size:0.8rem; display:none; }

/* OPR DROPDOWN STYLES */
.opr-row-wrap { margin-bottom: 8px; }
.opr-main-row { display:grid; grid-template-columns:1fr 70px 90px 30px; gap:8px; align-items:start; }
.opr-name-block { display:flex; flex-direction:column; gap:4px; }
.opr-course-select {
  border:1.5px solid var(--border-col); border-radius:8px;
  padding:7px 10px; font-family: Arial, sans-serif; font-size:0.82rem;
  width:100%; background:var(--select-bg); color:var(--text); cursor:pointer;
}
.opr-course-select:focus { outline:none; border-color:var(--uc); }
.opr-custom-input {
  border:1.5px solid var(--border-col); border-radius:8px;
  padding:6px 10px; font-family: Arial, sans-serif; font-size:0.78rem;
  width:100%; background:var(--el-input-bg); color:var(--text);
  display:none; margin-top:4px;
}
.opr-custom-input:focus { outline:none; border-color:var(--uc); }
.opr-sim-btn {
  background:none; border:none; color:var(--text); text-decoration:underline;
  cursor:pointer; padding:0; font-family: Arial, sans-serif;
  font-size:0.75rem; font-weight:bold; text-align:left;
}

.footer-credits {
  text-align: center; margin-top: 10px; padding-bottom: 40px;
  color: var(--muted); font-size: 0.9rem; font-weight: bold; letter-spacing: 1.5px;
}

@media(max-width:640px){
  .stats-bar { gap:14px; padding:12px 16px; }
  .calc-content { padding:20px 12px 20px; }
  .course-row { grid-template-columns:1fr 80px 80px 30px; }
  .final-grid { grid-template-columns:1fr; }
}
</style>
</head>
<body>

<div id="toast-felicidades">ğŸ‰ Â¡Felicidades!</div>

<div id="screen-career">
  <div class="career-logo">
    <img src="https://i.ibb.co/JjN0BKLC/Whats-App-Image-2025-12-10-at-21-40-35.jpg" alt="Logo CABIOUC" class="main-logo">
    <h1>Calculadora PPA</h1>
    <div class="gold-line"></div>
    <p>Facultad de Ciencias BiolÃ³gicas Â· ConsejerÃ­a AcadÃ©mica</p>
  </div>
  <div class="career-grid">
    <div class="career-card" onclick="selectCareer('bio')">
      <div class="career-icon">ğŸŒ³</div>
      <h3>BiologÃ­a Malla Antigua</h3>
    </div>
    <div class="career-card" onclick="selectCareer('bio_new')">
      <div class="career-icon">ğŸƒ</div>
      <h3>BiologÃ­a Malla Nueva</h3>
    </div>
    <div class="career-card" onclick="selectCareer('biomar')">
      <div class="career-icon">ğŸª¼</div>
      <h3>BiologÃ­a Marina Malla Antigua</h3>
    </div>
    <div class="career-card" onclick="selectCareer('biomar_new')">
      <div class="career-icon">ğŸ¡</div>
      <h3>BiologÃ­a Marina Malla Nueva</h3>
    </div>
    <div class="career-card" onclick="selectCareer('bq')">
      <div class="career-icon">ğŸ§¬</div>
      <h3>BioquÃ­mica</h3>
    </div>
  </div>
</div>

<div id="screen-calc">
  <div class="calc-header">
    <button class="back-btn" onclick="goBack()">â†</button>
    <div class="calc-header-info">
      <h2 id="calc-header-title">Cargando...</h2>
      <p>Ingresa tus notas Â· los ramos reprobados tambiÃ©n cuentan en el PPA general.</p>
    </div>
  </div>

  <div class="stats-bar">
    <div class="ppa-main">
      <div class="big" id="stat-ppa">â€”</div>
      <div class="lbl">PPA Actual</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <span class="val" id="stat-crd">0</span>
      <span class="lbl">CrÃ©ditos totales</span>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <span class="val" id="stat-apr">0</span>
      <span class="lbl">Aprobados</span>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <span class="val red" id="stat-rep">0</span>
      <span class="lbl">Reprobados</span>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <span class="val prog" id="stat-prog">0%</span>
      <span class="lbl">Avance (410 crd)</span>
    </div>
  </div>

  <div class="calc-content" id="calc-content"></div>
  <div class="footer-credits">CABIOUC 2026</div>
</div>

<div id="sim-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="sim-title">Simulador de Notas</h3>
      <button class="close-btn" onclick="closeSim()">Ã—</button>
    </div>
    <div class="exam-settings">
      <label style="display:flex; align-items:center; gap:8px; font-weight:bold; cursor:pointer; color:var(--text);">
        <input type="checkbox" id="sim-chk-exam" onchange="toggleSimExam()"> El curso tiene Examen Final
      </label>
      <div id="sim-exam-details" style="display:none; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; background:var(--input-bg); padding:10px; border-radius:8px; border:1px solid var(--border-col);">
        <div>
          <label style="font-size:0.75rem; color:var(--muted); font-weight:bold;">PonderaciÃ³n Examen (%)</label>
          <input type="number" id="sim-inp-exam-weight" class="sim-input" value="30" oninput="updateSimConfig()">
        </div>
        <div>
          <label style="font-size:0.75rem; color:var(--muted); font-weight:bold;">Nota para eximirse</label>
          <input type="number" id="sim-inp-exam-exim" class="sim-input" step="0.1" value="5.0" oninput="updateSimConfig()">
        </div>
      </div>
    </div>
    <p style="font-size:0.8rem; color:var(--muted); margin-bottom:12px; font-weight:bold; padding-left:4px;">
      ğŸ“Œ Evaluaciones de PresentaciÃ³n (Sus porcentajes deben sumar 100%)
    </p>
    <div id="sim-rows"></div>
    <button class="sim-add-btn" onclick="addSimRow()">+ Agregar evaluaciÃ³n</button>
    <div id="sim-exam-grade-box" style="display:none; margin-top:16px; background:var(--orange-bg); padding:12px; border-radius:8px; border:1.5px dashed var(--orange);">
      <label style="font-size:0.85rem; color:var(--orange); font-weight:bold; display:block; margin-bottom:6px;">ğŸ“ Tuviste que dar examen. Ingresa tu nota:</label>
      <input type="number" id="sim-inp-exam-grade" class="sim-input" style="border-color:var(--orange); max-width:150px;" min="1" max="7" step="0.1" placeholder="Nota Examen" oninput="updateSimExamGrade()">
    </div>
    <div class="sim-results" id="sim-results-content"></div>
    <button class="sim-save-btn" onclick="useSimGrade()">Guardar Nota Final en el Calculador PPA</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OPR LISTS PER CAREER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Los datos de mallas y OPRs se cargan desde
// los archivos externos (mallas/*.js y oprs/*.js)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// MALLAS y OPR_LISTS se leen desde window en selectCareer(),
// cuando los archivos externos ya estÃ¡n cargados.

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentCareer = null;
let MALLA = [];
let ofgReq = 70;
let oprReq = 20;
let grades = {};
let examGrado = null;
let efgExtra = [];
let oprLic = [];
let simData = {};
let currentSimCourse = null;
let uid = 0;

const EFG_AREAS = ['TeolÃ³gico','Humanidades','Artes','Salud y Bienestar','Cs. Sociales','EcologÃ­a y Sustentabilidad','Libre'];

function selectCareer(id) {
  currentCareer = id;
  MALLA = (window.MALLAS_DATA || {})[id] || [];
  const headerTitle = document.getElementById('calc-header-title');
  if (id==='bio')        { headerTitle.textContent='BiologÃ­a Malla Antigua';        ofgReq=70; oprReq=20; }
  else if (id==='bio_new')  { headerTitle.textContent='BiologÃ­a Malla Nueva';           ofgReq=60; oprReq=60; }
  else if (id==='biomar')   { headerTitle.textContent='BiologÃ­a Marina Malla Antigua';  ofgReq=60; oprReq=50; }
  else if (id==='biomar_new'){ headerTitle.textContent='BiologÃ­a Marina Malla Nueva';   ofgReq=60; oprReq=50; }
  else if (id==='bq')       { headerTitle.textContent='BioquÃ­mica';                     ofgReq=60; oprReq=15; }

  grades    = JSON.parse(localStorage.getItem('ppa4-g-'+id) || '{}');
  examGrado = grades.__exam__ !== undefined ? grades.__exam__ : null;
  efgExtra  = JSON.parse(localStorage.getItem('ppa4-efg-'+id) || '[]');
  oprLic    = JSON.parse(localStorage.getItem('ppa4-opr-'+id) || '[]');
  simData   = JSON.parse(localStorage.getItem('ppa4-sim-'+id) || '{}');

  let maxUid = 0;
  efgExtra.forEach(r => { if(parseInt(r.id.substring(1)) > maxUid) maxUid = parseInt(r.id.substring(1)); });
  oprLic.forEach(r => { if(parseInt(r.id.substring(1)) > maxUid) maxUid = parseInt(r.id.substring(1)); });
  uid = maxUid;

  document.getElementById('screen-career').style.display = 'none';
  document.getElementById('screen-calc').style.display = 'block';
  renderCalc();
}

function goBack() {
  document.getElementById('screen-career').style.display = 'flex';
  document.getElementById('screen-calc').style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCalc() {
  const c = document.getElementById('calc-content');
  c.innerHTML = '';

  MALLA.forEach(yr => {
    const yl = document.createElement('div');
    yl.className = 'year-label';
    yl.textContent = yr.year;
    c.appendChild(yl);

    yr.sems.forEach(sem => {
      const sec = document.createElement('div');
      sec.className = 'section';
      const crdTotal = sem.cursos.filter(x=>!x.noGrade).reduce((a,x)=>a+x.crd,0);
      sec.innerHTML = `<div class="section-header"><div class="section-num">${sem.num}</div><h3>${sem.label}</h3><span class="section-credits">${crdTotal} crÃ©ditos</span></div>`;
      if (sem.optionalNote) { const d=document.createElement('div'); d.className='optional-note'; d.textContent='* '+sem.optionalNote; sec.appendChild(d); }
      if (sem.note)         { const d=document.createElement('div'); d.className='info-pill'; d.textContent='ğŸ“Œ '+sem.note; sec.appendChild(d); }
      sem.cursos.forEach(curso => sec.appendChild(makeCourseBlock(curso)));
      c.appendChild(sec);
    });
  });

  c.appendChild(buildFinalSection());

  const block5to = document.createElement('div');
  block5to.className = 'fifth-year-box';
  block5to.innerHTML = 'ğŸ“ 5to aÃ±o prÃ³ximamente...';
  c.appendChild(block5to);

  const rr = document.createElement('div');
  rr.className = 'reset-row';
  rr.innerHTML = '<button class="reset-btn-main" onclick="resetAll()">ğŸ—‘ Reiniciar todo</button>';
  c.appendChild(rr);
  recalc();
}

function makeCourseBlock(curso) {
  if (curso.noGrade) {
    const d = document.createElement('div');
    d.className = 'no-grade-row';
    d.innerHTML = `ğŸ“‹ <strong>${curso.code}</strong> â€” ${curso.name} &nbsp;<em style="color:#aaa;">(sin nota Â· requisito administrativo)</em>`;
    return d;
  }

  const wrap = document.createElement('div');
  wrap.id = 'block-' + curso.code;
  wrap.style.marginBottom = '6px';

  if (!Array.isArray(grades[curso.code])) {
    const old = grades[curso.code];
    grades[curso.code] = (old && old.nota !== undefined && old.nota !== '') ? [old.nota] : [''];
  }

  const optTag = curso.optional ? ' <span style="color:var(--gold);font-size:0.65rem;font-weight:700;">OPT</span>' : '';

  const rebuildRows = () => {
    wrap.innerHTML = '';
    const atts = grades[curso.code];
    atts.forEach((nota, idx) => {
      const n = parseFloat(nota);
      const hasN = nota !== '' && !isNaN(n) && n >= 1 && n <= 7;
      const aprobado = hasN && n >= 4.0;
      const isRetry = idx > 0;
      let rowClass = 'course-row';
      if (hasN) rowClass += aprobado ? ' graded' : ' failed';
      const intentoBadge = isRetry ? `<span style="display:inline-block;background:var(--orange);color:white;font-size:0.6rem;font-weight:700;padding:1px 6px;border-radius:10px;margin-right:4px;">Intento ${idx+1}</span>` : '';
      const row = document.createElement('div');
      row.className = rowClass;
      row.id = 'row-' + curso.code + '-' + idx;
      row.innerHTML = `
        <div class="course-info">
          <div class="course-code">${curso.code}${optTag} ${intentoBadge}</div>
          <div class="course-name" title="${curso.name}">${curso.name}</div>
          <div class="course-crd">
            ${curso.crd} crÃ©ditos Â· 
            <button class="btn-link" onclick="openSim('${curso.code}', '${curso.name.replace(/'/g,"\\'")}', 'malla', ${idx})" style="font-size:0.75rem; font-weight:bold;">ğŸ“Š Simular notas del ramo</button>
          </div>
        </div>
        <input class="grade-input ${hasN?(aprobado?'valid':'invalid'):''}" type="number"
          min="1" max="7" step="0.1" placeholder="Nota Final" value="${nota}"
          oninput="setAttemptGrade('${curso.code}', ${idx}, this)" />
        <div class="course-status" id="status-${curso.code}-${idx}">
          ${hasN ? (aprobado ? 'âœ“ Aprobado' : 'âœ— Reprobado') : 'â€”'}
        </div>
        <div>
          ${isRetry ? `<button class="del-btn" onclick="removeAttempt('${curso.code}', ${idx})" title="Eliminar intento" style="font-size:1.3rem;">Ã—</button>` : ''}
        </div>
      `;
      wrap.appendChild(row);
    });

    const lastNota = parseFloat(atts[atts.length - 1]);
    const approvedAlready = atts.some(n => parseFloat(n) >= 4.0);
    const retryBtn = document.createElement('button');
    retryBtn.className = 'retry-btn';
    retryBtn.id = 'retry-btn-' + curso.code;
    retryBtn.textContent = '+ Agregar repeticiÃ³n de este ramo';
    retryBtn.style.display = (!isNaN(lastNota) && lastNota >= 1 && lastNota < 4 && !approvedAlready) ? 'block' : 'none';
    retryBtn.onclick = () => { addAttempt(curso.code); };
    wrap.appendChild(retryBtn);
  };

  rebuildRows();
  wrap._rebuild = rebuildRows;
  return wrap;
}

function buildFinalSection() {
  const box = document.createElement('div');
  box.className = 'final-section';
  box.id = 'final-section';
  box.innerHTML = `<h3>ğŸ“Š Electivos, Examen de Grado y Notas Finales</h3>`;

  // OFG
  const efgB = document.createElement('div');
  efgB.className = 'elective-block';
  efgB.innerHTML = `<h4>OFG â€” Optativos de FormaciÃ³n General (${ofgReq} crÃ©ditos requeridos)</h4>`;
  efgB.id = 'efg-block';
  efgExtra.forEach(r => efgB.appendChild(makeEFGRow(r)));
  const addEFG = document.createElement('button');
  addEFG.className = 'add-btn'; addEFG.textContent = '+ Agregar OFG';
  addEFG.onclick = () => {
    const r = {id:'e'+(++uid), nombre:'', area:'', crd:10, nota:''};
    efgExtra.push(r); saveEFG();
    document.getElementById('efg-block').insertBefore(makeEFGRow(r), addEFG);
    recalc();
  };
  efgB.appendChild(addEFG);
  box.appendChild(efgB);

  // OPR
  const oprB = document.createElement('div');
  oprB.className = 'elective-block';
  oprB.innerHTML = `<h4>OPR (Optativo de profundizaciÃ³n) â€” ${oprReq} crÃ©ditos requeridos</h4>`;
  oprB.id = 'opr-block';
  oprLic.forEach(r => oprB.appendChild(makeOPRRow(r)));
  const addOPR = document.createElement('button');
  addOPR.className = 'add-btn'; addOPR.textContent = '+ Agregar OPR';
  addOPR.onclick = () => {
    const r = {id:'o'+(++uid), nombre:'', code:'', crd:10, nota:''};
    oprLic.push(r); saveOPR();
    document.getElementById('opr-block').insertBefore(makeOPRRow(r), addOPR);
    recalc();
  };
  oprB.appendChild(addOPR);
  box.appendChild(oprB);

  // Examen
  const examDiv = document.createElement('div');
  examDiv.className = 'exam-box';
  examDiv.innerHTML = `
    <div class="exam-info">
      <h4>Examen de Grado</h4>
      <p>PonderaciÃ³n: 25% de la Nota de Licenciatura</p>
      <p style="font-size:0.72rem;color:#bbb;margin-top:3px;">Nota Lic. = (0.75 Ã— PPA) + (0.25 Ã— Ex. Grado)</p>
    </div>
    <input class="exam-input" type="number" min="1" max="7" step="0.1"
      placeholder="â€”" value="${examGrado!==null?examGrado:''}"
      oninput="setExamen(this.value)" />
  `;
  box.appendChild(examDiv);

  const grid = document.createElement('div');
  grid.className = 'final-grid'; grid.id = 'final-grid';
  box.appendChild(grid);

  return box;
}

function makeEFGRow(r) {
  const div = document.createElement('div');
  div.style.cssText = 'display:grid;grid-template-columns:1fr 130px 60px 90px 30px;gap:8px;align-items:center;margin-bottom:6px;';
  div.id = 'efg-' + r.id;

  const nameWrap = document.createElement('div');
  const ni = document.createElement('input');
  ni.className='el-input'; ni.type='text'; ni.placeholder='Nombre del OFG'; ni.value=r.nombre||'';
  ni.oninput = e => { r.nombre=e.target.value; saveEFG(); };
  const simBtn = document.createElement('button');
  simBtn.className='btn-link'; simBtn.textContent='ğŸ“Š Simular notas';
  simBtn.style.cssText='font-size:0.75rem; font-weight:bold; margin-top:4px; display:block; text-align:left;';
  simBtn.onclick = () => openSim(r.id, r.nombre||'OFG', 'efg', r.id);
  nameWrap.appendChild(ni); nameWrap.appendChild(simBtn);

  const sel = document.createElement('select'); sel.className='el-select';
  sel.innerHTML = '<option value="">â€” Ãrea â€”</option>' + EFG_AREAS.map(a=>`<option ${r.area===a?'selected':''} value="${a}">${a}</option>`).join('');
  sel.onchange = e => { r.area=e.target.value; saveEFG(); };

  const ci=document.createElement('input'); ci.className='el-input'; ci.type='number'; ci.min=1; ci.placeholder='Crd'; ci.value=r.crd||10; ci.style.textAlign='center';
  ci.oninput=e=>{r.crd=parseInt(e.target.value)||0;saveEFG();recalc();};

  const inp=document.createElement('input'); inp.className='el-input'; inp.type='number'; inp.min=1; inp.max=7; inp.step=0.1;
  inp.placeholder='Nota'; inp.value=r.nota||''; inp.style.textAlign='center'; inp.style.fontWeight='bold';
  inp.oninput=e=>{r.nota=e.target.value;saveEFG();recalc();};

  const del=document.createElement('button'); del.className='del-btn'; del.textContent='Ã—';
  del.onclick=()=>{ efgExtra=efgExtra.filter(x=>x.id!==r.id); saveEFG(); delete simData[r.id]; saveSim(); div.remove(); recalc(); };

  div.appendChild(nameWrap); div.appendChild(sel); div.appendChild(ci); div.appendChild(inp); div.appendChild(del);
  return div;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OPR ROW â€” con selector de cursos por carrera
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeOPRRow(r) {
  const wrap = document.createElement('div');
  wrap.className = 'opr-row-wrap';
  wrap.id = 'opr-' + r.id;

  const mainRow = document.createElement('div');
  mainRow.className = 'opr-main-row';

  // Name block with dropdown
  const nameBlock = document.createElement('div');
  nameBlock.className = 'opr-name-block';

  const courseList = (window.OPR_DATA || {})[currentCareer] || [];

  // Dropdown
  const sel = document.createElement('select');
  sel.className = 'opr-course-select';

  let optsHtml = '<option value="">â€” Selecciona un OPR â€”</option>';
  courseList.forEach(c => {
    const val = c.code + '|' + c.name;
    const isSel = (r.code === c.code) ? 'selected' : '';
    optsHtml += `<option value="${val.replace(/"/g,'&quot;')}" ${isSel}>${c.code} Â· ${c.name}</option>`;
  });
  optsHtml += '<option value="__custom__">âœï¸ Otro (ingresar manualmente)</option>';
  sel.innerHTML = optsHtml;

  // Custom input
  const customInput = document.createElement('input');
  customInput.className = 'opr-custom-input';
  customInput.type = 'text';
  customInput.placeholder = 'CÃ³digo Â· Nombre del ramo';

  // Determine if current value is custom (not in list)
  const inList = courseList.find(c => c.code === r.code);
  if (r.code && !inList) {
    sel.value = '__custom__';
    customInput.style.display = 'block';
    customInput.value = r.code + (r.nombre ? ' Â· ' + r.nombre : '');
  } else if (!r.code) {
    customInput.style.display = 'none';
  }

  sel.onchange = e => {
    const val = e.target.value;
    if (val === '__custom__') {
      customInput.style.display = 'block';
      customInput.focus();
      r.code = '';
      r.nombre = '';
    } else if (val === '') {
      customInput.style.display = 'none';
      r.code = ''; r.nombre = '';
    } else {
      customInput.style.display = 'none';
      const pipeIdx = val.indexOf('|');
      r.code = val.substring(0, pipeIdx);
      r.nombre = val.substring(pipeIdx + 1);
    }
    saveOPR();
  };

  customInput.oninput = e => {
    r.nombre = e.target.value;
    r.code = '';
    saveOPR();
  };

  // Simulate button
  const simBtn = document.createElement('button');
  simBtn.className = 'opr-sim-btn';
  simBtn.textContent = 'ğŸ“Š Simular notas';
  simBtn.onclick = () => openSim(r.id, r.nombre || r.code || 'OPR', 'opr', r.id);

  nameBlock.appendChild(sel);
  nameBlock.appendChild(customInput);
  nameBlock.appendChild(simBtn);

  // Credits
  const ci = document.createElement('input');
  ci.className='el-input'; ci.type='number'; ci.min=1; ci.placeholder='Crd'; ci.value=r.crd||10; ci.style.textAlign='center';
  ci.oninput=e=>{r.crd=parseInt(e.target.value)||0;saveOPR();recalc();};

  // Grade
  const gi = document.createElement('input');
  gi.className='el-input'; gi.type='number'; gi.min=1; gi.max=7; gi.step=0.1;
  gi.placeholder='Nota'; gi.value=r.nota||''; gi.style.textAlign='center'; gi.style.fontWeight='bold';
  gi.oninput=e=>{r.nota=e.target.value;saveOPR();recalc();};

  // Delete
  const del = document.createElement('button');
  del.className='del-btn'; del.textContent='Ã—';
  del.onclick=()=>{
    oprLic=oprLic.filter(x=>x.id!==r.id);
    saveOPR(); delete simData[r.id]; saveSim(); wrap.remove(); recalc();
  };

  mainRow.appendChild(nameBlock);
  mainRow.appendChild(ci);
  mainRow.appendChild(gi);
  mainRow.appendChild(del);
  wrap.appendChild(mainRow);
  return wrap;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRADE SETTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setAttemptGrade(code, idx, input) {
  if (!Array.isArray(grades[code])) grades[code] = [''];
  grades[code][idx] = input.value;
  saveGrades();
  const n = parseFloat(input.value);
  const hasN = input.value !== '' && !isNaN(n) && n >= 1 && n <= 7;
  const aprobado = hasN && n >= 4.0;
  input.classList.remove('valid','invalid');
  if (hasN) input.classList.add(aprobado?'valid':'invalid');
  const row = document.getElementById('row-'+code+'-'+idx);
  if (row) { row.classList.remove('graded','failed'); if (hasN) row.classList.add(aprobado?'graded':'failed'); }
  const st = document.getElementById('status-'+code+'-'+idx);
  if (st) st.textContent = !hasN ? 'â€”' : (aprobado?'âœ“ Aprobado':'âœ— Reprobado');
  const retryBtn = document.getElementById('retry-btn-'+code);
  if (retryBtn) {
    const atts = grades[code];
    const lastNota = parseFloat(atts[atts.length-1]);
    const approvedAlready = atts.some(x=>parseFloat(x)>=4.0);
    retryBtn.style.display = (!isNaN(lastNota)&&lastNota>=1&&lastNota<4&&!approvedAlready)?'block':'none';
  }
  recalc();
}

function addAttempt(code) {
  if (!Array.isArray(grades[code])) grades[code] = [];
  grades[code].push(''); saveGrades();
  const block = document.getElementById('block-'+code);
  if (block&&block._rebuild) block._rebuild();
  recalc();
}

function removeAttempt(code, idx) {
  if (!Array.isArray(grades[code])) return;
  grades[code].splice(idx, 1); saveGrades();
  const block = document.getElementById('block-'+code);
  if (block&&block._rebuild) block._rebuild();
  recalc();
}

let prevExamGrado = null;
function setExamen(val) {
  examGrado = val===''?null:parseFloat(val);
  grades.__exam__ = examGrado; saveGrades(); recalc();
  if (examGrado!==null&&!isNaN(examGrado)&&examGrado>=1&&examGrado<=7&&examGrado!==prevExamGrado) {
    prevExamGrado = examGrado;
    if (typeof confetti==='function') confetti({particleCount:150,spread:70,origin:{y:0.6}});
    const toast = document.getElementById('toast-felicidades');
    toast.className = 'show';
    setTimeout(()=>{ toast.className=toast.className.replace('show',''); }, 3500);
  } else if (examGrado===null||isNaN(examGrado)) { prevExamGrado=null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIMULADOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatReq(n) {
  if (n<=1) return 'Ya lo lograste (MÃ­n. 1.0)';
  if (n>7) return n.toFixed(2)+' (Imposible)';
  return n.toFixed(2);
}

function openSim(code, name, type, targetId) {
  currentSimCourse = {code, name, type, targetId};
  if (!simData[code]||Array.isArray(simData[code])) {
    simData[code] = {
      hasExam:false, examWeight:30, eximGrade:5.0,
      evals: Array.isArray(simData[code]) ? simData[code] : [
        {name:'InterrogaciÃ³n 1',weight:30,grade:''},
        {name:'InterrogaciÃ³n 2',weight:30,grade:''},
        {name:'Tareas',weight:40,grade:''}
      ],
      examGrade:''
    };
  }
  const data = simData[code];
  document.getElementById('sim-title').textContent = name;
  document.getElementById('sim-chk-exam').checked = data.hasExam;
  document.getElementById('sim-exam-details').style.display = data.hasExam?'grid':'none';
  document.getElementById('sim-inp-exam-weight').value = data.examWeight;
  document.getElementById('sim-inp-exam-exim').value = data.eximGrade;
  document.getElementById('sim-inp-exam-grade').value = data.examGrade||'';
  renderSim();
  document.getElementById('sim-modal').style.display = 'flex';
}

function closeSim() { document.getElementById('sim-modal').style.display='none'; }

function toggleSimExam() {
  const isChecked = document.getElementById('sim-chk-exam').checked;
  simData[currentSimCourse.code].hasExam = isChecked;
  document.getElementById('sim-exam-details').style.display = isChecked?'grid':'none';
  saveSim(); calcSimTotals();
}

function updateSimConfig() {
  simData[currentSimCourse.code].examWeight = parseFloat(document.getElementById('sim-inp-exam-weight').value)||0;
  simData[currentSimCourse.code].eximGrade = parseFloat(document.getElementById('sim-inp-exam-exim').value)||5.0;
  saveSim(); calcSimTotals();
}

function updateSimExamGrade() {
  simData[currentSimCourse.code].examGrade = document.getElementById('sim-inp-exam-grade').value;
  saveSim(); calcSimTotals();
}

function renderSim() {
  const container = document.getElementById('sim-rows');
  container.innerHTML = '';
  simData[currentSimCourse.code].evals.forEach((item, i) => {
    const div = document.createElement('div');
    div.className = 'sim-row';
    div.innerHTML = `
      <input class="sim-input sim-input-text" type="text" placeholder="Ej: Control 1" value="${item.name}" oninput="updateSim(${i},'name',this.value)">
      <input class="sim-input" type="number" min="0" max="100" placeholder="%" value="${item.weight}" oninput="updateSim(${i},'weight',this.value)">
      <input class="sim-input" type="number" min="1" max="7" step="0.1" placeholder="Nota" value="${item.grade}" oninput="updateSim(${i},'grade',this.value)">
      <button class="del-btn" onclick="delSim(${i})" style="font-size:1.4rem;">Ã—</button>
    `;
    container.appendChild(div);
  });
  calcSimTotals();
}

function updateSim(idx,field,val){ simData[currentSimCourse.code].evals[idx][field]=val; saveSim(); calcSimTotals(); }
function addSimRow(){ simData[currentSimCourse.code].evals.push({name:'',weight:'',grade:''}); saveSim(); renderSim(); }
function delSim(idx){ simData[currentSimCourse.code].evals.splice(idx,1); saveSim(); renderSim(); }
function saveSim(){ localStorage.setItem('ppa4-sim-'+currentCareer, JSON.stringify(simData)); }

function calcSimTotals() {
  const data = simData[currentSimCourse.code];
  let wSum=0, npAccum=0;
  data.evals.forEach(ev=>{ let w=parseFloat(ev.weight)||0; let g=parseFloat(ev.grade); wSum+=w; if(!isNaN(g)&&g>=1&&g<=7) npAccum+=g*(w/100); });
  const wMissing = Math.max(0,100-wSum);
  let resHTML = '';
  resHTML += `<p>Total de presentaciÃ³n ingresado: <span style="font-weight:bold; color:${wSum>100?'var(--red)':'var(--text)'}">${wSum}% / 100%</span></p>`;

  if (wSum<100) {
    let currentAvg = wSum>0?(npAccum/(wSum/100)).toFixed(2):'â€”';
    resHTML += `<p>Promedio ponderado a la fecha: <strong>${currentAvg}</strong></p>`;
    let req4 = (4.0-npAccum)/(wMissing/100);
    resHTML += `<p>Nota necesaria en el ${wMissing}% restante para NP 4.0: <strong class="${req4>7?'req-grade':''}">${formatReq(req4)}</strong></p>`;
    if (data.hasExam) {
      let reqExim = (data.eximGrade-npAccum)/(wMissing/100);
      resHTML += `<p>Nota necesaria en el ${wMissing}% restante para Eximirte (NP ${data.eximGrade}): <strong class="${reqExim>7?'req-grade':''}">${formatReq(reqExim)}</strong></p>`;
    }
    document.getElementById('sim-exam-grade-box').style.display='none';
  } else if (wSum===100) {
    let np=npAccum;
    resHTML += `<p>Nota de PresentaciÃ³n (NP): <strong style="font-size:1.1rem;">${np.toFixed(2)}</strong></p>`;
    if (!data.hasExam) {
      resHTML += `<hr style="border:0;border-top:1px solid var(--border-col);margin:10px 0;">`;
      resHTML += `<p>Nota Final del Ramo: <strong style="color:${np>=4?'var(--green)':'var(--red)'};font-size:1.2rem;">${np.toFixed(1)}</strong></p>`;
      document.getElementById('sim-exam-grade-box').style.display='none';
    } else {
      if (np>=data.eximGrade) {
        resHTML += `<p style="color:var(--green);font-weight:bold;">ğŸ‰ Â¡Felicidades! Te eximiste del examen.</p>`;
        resHTML += `<hr style="border:0;border-top:1px solid var(--border-col);margin:10px 0;">`;
        resHTML += `<p>Nota Final del Ramo: <strong style="color:var(--green);font-size:1.2rem;">${np.toFixed(1)}</strong></p>`;
        document.getElementById('sim-exam-grade-box').style.display='none';
      } else {
        resHTML += `<p style="color:var(--orange);font-weight:bold;">âš ï¸ No te eximes (NP menor a ${data.eximGrade.toFixed(1)}).</p>`;
        let ew=data.examWeight/100;
        let reqExam=(4.0-np*(1-ew))/ew;
        resHTML += `<p>Nota necesaria en el Examen para aprobar (4.0): <strong class="${reqExam>7?'req-grade':''}">${formatReq(reqExam)}</strong></p>`;
        document.getElementById('sim-exam-grade-box').style.display='block';
        let gEx=parseFloat(data.examGrade);
        if (!isNaN(gEx)&&gEx>=1&&gEx<=7) {
          let nf=np*(1-ew)+gEx*ew;
          resHTML += `<hr style="border:0;border-top:1px solid var(--border-col);margin:10px 0;">`;
          resHTML += `<p>Nota Final del Ramo: <strong style="color:${nf>=4?'var(--green)':'var(--red)'};font-size:1.2rem;">${nf.toFixed(1)}</strong></p>`;
        } else {
          resHTML += `<hr style="border:0;border-top:1px solid var(--border-col);margin:10px 0;">`;
          resHTML += `<p>Nota Final del Ramo: <strong>Esperando nota de examen...</strong></p>`;
        }
      }
    }
  } else {
    resHTML += `<p style="color:var(--red);font-weight:bold;">Los porcentajes de presentaciÃ³n suman mÃ¡s de 100%. Por favor corrige los valores.</p>`;
    document.getElementById('sim-exam-grade-box').style.display='none';
  }
  document.getElementById('sim-results-content').innerHTML = resHTML;
}

function useSimGrade() {
  const data = simData[currentSimCourse.code];
  let wSum=0, npAccum=0;
  data.evals.forEach(ev=>{ let w=parseFloat(ev.weight)||0; let g=parseFloat(ev.grade); wSum+=w; if(!isNaN(g)&&g>=1&&g<=7) npAccum+=g*(w/100); });
  if (wSum!==100) { alert('Para usar la nota, los porcentajes de presentaciÃ³n deben sumar exactamente 100%.'); return; }
  let finalGrade=0;
  if (!data.hasExam) { finalGrade=npAccum; }
  else {
    if (npAccum>=data.eximGrade) { finalGrade=npAccum; }
    else {
      let ex=parseFloat(data.examGrade);
      if (isNaN(ex)||ex<1||ex>7) { alert('Como no te eximiste, debes ingresar la nota del examen final.'); return; }
      let ew=data.examWeight/100;
      finalGrade=npAccum*(1-ew)+ex*ew;
    }
  }
  const finalStr = finalGrade.toFixed(1);
  if (currentSimCourse.type==='malla') {
    const idx=currentSimCourse.targetId;
    const inp=document.querySelector(`#row-${currentSimCourse.code}-${idx} .grade-input`);
    if (inp) { inp.value=finalStr; setAttemptGrade(currentSimCourse.code,idx,inp); }
    else {
      if(!Array.isArray(grades[currentSimCourse.code])) grades[currentSimCourse.code]=[''];
      grades[currentSimCourse.code][idx]=finalStr; saveGrades();
      const block=document.getElementById('block-'+currentSimCourse.code);
      if(block) block._rebuild(); recalc();
    }
  } else if (currentSimCourse.type==='efg') {
    const item=efgExtra.find(x=>x.id===currentSimCourse.targetId);
    if (item) {
      item.nota=finalStr; saveEFG();
      const inputs=document.querySelectorAll(`#efg-${item.id} input.el-input`);
      inputs.forEach(i=>{if(i.placeholder==='Nota') i.value=finalStr;}); recalc();
    }
  } else if (currentSimCourse.type==='opr') {
    const item=oprLic.find(x=>x.id===currentSimCourse.targetId);
    if (item) {
      item.nota=finalStr; saveOPR();
      const oprWrap=document.getElementById('opr-'+item.id);
      if (oprWrap) {
        const gradeInputs=oprWrap.querySelectorAll('input[type="number"]');
        gradeInputs.forEach(inp=>{if(inp.placeholder==='Nota') inp.value=finalStr;});
      }
      recalc();
    }
  }
  closeSim();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECALC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function recalc() {
  let sumP=0, sumC=0, apr=0, rep=0, aprCrdTotal=0;
  MALLA.forEach(yr=>yr.sems.forEach(sem=>sem.cursos.forEach(c=>{
    if(c.noGrade) return;
    const atts=Array.isArray(grades[c.code])?grades[c.code]:[];
    atts.forEach(nota=>{ const n=parseFloat(nota); if(isNaN(n)||n<1||n>7) return; sumP+=n*c.crd; sumC+=c.crd; if(n>=4){apr++;aprCrdTotal+=c.crd;}else{rep++;} });
  })));
  efgExtra.forEach(r=>{ const n=parseFloat(r.nota),crd=parseInt(r.crd)||0; if(isNaN(n)||n<1||n>7||crd<=0) return; sumP+=n*crd;sumC+=crd; if(n>=4){apr++;aprCrdTotal+=crd;}else{rep++;} });
  oprLic.forEach(r=>{ const n=parseFloat(r.nota),crd=parseInt(r.crd)||0; if(isNaN(n)||n<1||n>7||crd<=0) return; sumP+=n*crd;sumC+=crd; if(n>=4){apr++;aprCrdTotal+=crd;}else{rep++;} });

  const ppa=sumC>0?sumP/sumC:null;
  const examN=examGrado!==null&&!isNaN(examGrado)&&examGrado>=1&&examGrado<=7?examGrado:null;
  const notaLic=ppa!==null&&examN!==null?(0.75*ppa)+(0.25*examN):null;
  const progress=Math.min(100,(aprCrdTotal/410)*100);

  const pe=document.getElementById('stat-ppa');
  if(ppa!==null){pe.textContent=ppa.toFixed(2);pe.className='big '+(ppa>=5.5?'good':ppa>=4.5?'warn':'bad');}
  else{pe.textContent='â€”';pe.className='big';}
  document.getElementById('stat-crd').textContent=sumC;
  document.getElementById('stat-apr').textContent=apr;
  document.getElementById('stat-rep').textContent=rep;
  document.getElementById('stat-prog').textContent=progress.toFixed(1)+'%';

  const grid=document.getElementById('final-grid');
  if(grid) grid.innerHTML=`
    <div class="final-box">
      <div class="fl">PPA Licenciatura</div>
      <div class="fn">${ppa!==null?ppa.toFixed(2):'â€”'}</div>
      <div class="formula">${sumC} crÃ©ditos Â· ${apr+rep} ramos con nota</div>
    </div>
    <div class="final-box">
      <div class="fl">Nota de Licenciatura</div>
      <div class="fn">${notaLic!==null?notaLic.toFixed(2):(ppa!==null?'Falta examen':'â€”')}</div>
      <div class="formula">0.75 Ã— PPA + 0.25 Ã— Examen de Grado</div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveGrades(){ localStorage.setItem('ppa4-g-'+currentCareer, JSON.stringify(grades)); }
function saveEFG()   { localStorage.setItem('ppa4-efg-'+currentCareer, JSON.stringify(efgExtra)); }
function saveOPR()   { localStorage.setItem('ppa4-opr-'+currentCareer, JSON.stringify(oprLic)); }

function resetAll(){
  if(!confirm('Â¿Eliminar todas las notas?')) return;
  grades={};efgExtra=[];oprLic=[];examGrado=null;simData={};
  localStorage.removeItem('ppa4-g-'+currentCareer);
  localStorage.removeItem('ppa4-efg-'+currentCareer);
  localStorage.removeItem('ppa4-opr-'+currentCareer);
  localStorage.removeItem('ppa4-sim-'+currentCareer);
  renderCalc();
}
</script>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DATOS DE MALLAS â€” edita solo el archivo que necesites
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="mallas/bio.js"></script>
<script src="mallas/bio_new.js"></script>
<script src="mallas/biomar.js"></script>
<script src="mallas/biomar_new.js"></script>
<script src="mallas/bq.js"></script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DATOS DE OPRs â€” edita solo el archivo que necesites
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="oprs/bio.js"></script>
<script src="oprs/bio_new.js"></script>
<script src="oprs/biomar.js"></script>
<script src="oprs/biomar_new.js"></script>
<script src="oprs/bq.js"></script>
</body>
</html>
